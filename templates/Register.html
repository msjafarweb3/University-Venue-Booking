<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Register - Venue Booking</title>
  <link rel="icon" type="image/png" href="/static/cropped-nsuk.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/creative_auth.css">
</head>
<body>
  <div class="auth-page-wrapper">
    <div class="auth-form-section">
      <div class="auth-form-card">
        <div class="form-header-content">
          <h4 class="form-title text-center text-uppercase">Sign Up</h4>
        </div>

        <div id="messageDisplay" class="alert d-none" role="alert"></div>

        <form id="registerForm">
          <div class="mb-3">
            <label for="role" class="form-label">Register As</label>
            <select class="form-select" id="role" required>
              <option value="">Select Role</option>
              <option value="student">Student</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="fullname" class="form-label">Full Name</label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-user"></i></span>
                <input type="text" class="form-control" id="fullname" placeholder="Enter your full name" required />
            </div>
          </div>
          <div class="mb-3" id="matricNoField" style="display: none;">
            <label for="matricNo" class="form-label">Matriculation Number</label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                <input type="text" class="form-control" id="matricNo" placeholder="Enter your matriculation number" />
            </div>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email address</label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                <input type="email" class="form-control" id="email" placeholder="Enter your email" required />
            </div>
          </div>
          <div class="mb-3 position-relative">
            <label for="password" class="form-label">Password</label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                <input type="password" class="form-control" id="password" placeholder="Create a password" required />
            </div>
          </div>
          <div class="mb-4 position-relative">
            <label for="confirmPassword" class="form-label">Confirm Password</label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm password" required />
            </div>
          </div>
          <button type="submit" class="btn btn-success w-100 py-2 mb-4">SIGN UP</button>
        </form>

        <p class="text-center mt-3 small">
          Already have an account? <a href="http://127.0.0.1:5000/login" class="text-success fw-bold text-decoration-none">SIGN IN</a>
        </p>
      </div>
    </div>

    <div class="auth-promo-section">
      <div class="promo-content">
        <img src="/static/cropped-nsuk.png" alt="University Logo" class="promo-logo mb-4">
        <h2 class="fw-bold mb-3">Welcome to NSUK!</h2>
        <p class="mb-4">Register now to streamline your venue reservations for academic and administrative purposes at Nasarawa State University, Keffi.</p>
        <a href="http://127.0.0.1:5000/login" class="btn btn-success btn-lg rounded-pill px-5 py-3 fw-bold shadow">SIGN IN</a>
      </div>
    </div>
  </div>

  <div class="modal fade" id="customModal" tabindex="-1" aria-labelledby="customModalLabel" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="customModalLabel"></h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="customModalBody">
              </div>
              <div class="modal-footer" id="customModalFooter">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-success d-none" id="customModalConfirmBtn">Confirm</button>
              </div>
          </div>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Base URL for API calls (adjust if your Flask app is on a different host/port)
    const API_BASE_URL = 'http://127.0.0.1:5000';

    // Function to display messages (success or error)
    function showMessage(message, isError = false, targetId = "messageDisplay") {
        const messageDiv = document.getElementById(targetId);
        if (messageDiv) {
            messageDiv.textContent = message;
            messageDiv.className = `alert ${isError ? 'alert-danger' : 'alert-success'} d-block`;
            // Automatically hide the message after 3 seconds
            setTimeout(() => {
                messageDiv.classList.remove('d-block');
                messageDiv.classList.add('d-none');
            }, 3000);
        }
    }

    // --- Custom Alert/Confirm Modals (replaces browser's alert/confirm) ---
    // This structure is added here for consistency, ensuring all pages have the modal functionality.
    // It's checked in DOMContentLoaded to prevent multiple additions.

    function showCustomModal(title, bodyHtml, isConfirm = false, onConfirmCallback = null) {
        const modalElement = document.getElementById('customModal');
        const modalTitle = document.getElementById('customModalLabel');
        const modalBody = document.getElementById('customModalBody');
        const modalConfirmBtn = document.getElementById('customModalConfirmBtn');
        const bootstrapModal = new bootstrap.Modal(modalElement);

        modalTitle.textContent = title;
        modalBody.innerHTML = bodyHtml;

        if (isConfirm) {
            modalConfirmBtn.classList.remove('d-none');
            modalConfirmBtn.onclick = () => {
                bootstrapModal.hide();
                if (onConfirmCallback) {
                    onConfirmCallback();
                }
            };
        } else {
            modalConfirmBtn.classList.add('d-none');
            modalConfirmBtn.onclick = null; // Clear previous click handler
        }

        bootstrapModal.show();
    }

    // A wrapper for confirm-like actions using the custom modal
    function showCustomConfirm(message, onConfirmCallback) {
        showCustomModal('Confirmation', message, true, onConfirmCallback);
    }

    // Event listener for role selection to show/hide Matric No. field
    document.getElementById("role").addEventListener("change", function() {
        const role = this.value;
        const matricNoField = document.getElementById("matricNoField");
        const matricNoInput = document.getElementById("matricNo");
        const matricNoLabel = matricNoField.querySelector('label');

        if (role === "student") { // Only show for student
            matricNoField.style.display = "block";
            matricNoInput.setAttribute("required", "required");
            matricNoLabel.textContent = "Matriculation Number";
            matricNoInput.placeholder = "Enter your matriculation number";
        } else {
            matricNoField.style.display = "none";
            matricNoInput.removeAttribute("required");
            matricNoInput.value = ""; // Clear value if hidden
        }
    });

    // Event listener for the registration form submission
    document.getElementById("registerForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      // Clear previous messages
      showMessage('', false);
      document.getElementById('messageDisplay').classList.add('d-none'); // Hide it immediately

      const role = document.getElementById("role").value;
      const fullname = document.getElementById("fullname").value;
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirmPassword").value;
      const matricNo = document.getElementById("matricNo").value; // Get matric_no

      if (password !== confirmPassword) {
        showMessage("Passwords do not match.", true);
        return;
      }

      // Client-side validation for matricNo based on role
      if (role === "student" && !matricNo) { // Only require matricNo for student
        showMessage(`Matriculation Number is required for student registration.`, true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ role, fullname, email, password, matric_no: matricNo }) // Include matric_no
        });

        const result = await response.json();
        if (response.ok) {
          showMessage(result.message, false); // Displays "Registration successful! Awaiting admin approval."
          setTimeout(() => {
              window.location.href = `${API_BASE_URL}/login`;
          }, 2000);
        } else {
          showMessage(result.error || "Registration failed.", true);
        }
      } catch (error) {
        console.error('Error during registration:', error);
        showMessage('Registration failed due to network error.', true);
      }
    });

    // Ensure the custom modal HTML is present in the DOM when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        if (!document.getElementById('customModal')) {
            const modalHtml = `
                <div class="modal fade" id="customModal" tabindex="-1" aria-labelledby="customModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="customModalLabel"></h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="customModalBody">
                            </div>
                            <div class="modal-footer" id="customModalFooter">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-success d-none" id="customModalConfirmBtn">Confirm</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
    });
  </script>
</body>
</html>