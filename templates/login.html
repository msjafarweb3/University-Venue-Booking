<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Venue Booking Login</title>
    <link rel="icon" type="image/png" href="/static/cropped-nsuk.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/creative_auth.css">
</head>
<body>
    <div class="auth-page-wrapper">
        <div class="auth-form-section">
            <div class="auth-form-card">
                <div class="form-header-content">
                    <h4 class="form-title text-center text-uppercase">Sign In</h4>
                </div>

                <div id="messageDisplay" class="alert d-none" role="alert"></div>

                <form id="loginForm">
                    <div class="mb-3">
                        <label for="role" class="form-label">Login As</label>
                        <select class="form-select" id="role" required>
                            <option value="">Select Role</option>
                            <option value="student">Student</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="identifier" class="form-label">Email or Matric No.</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                            <input type="text" class="form-control" id="identifier" placeholder="Enter your email or ID" required />
                        </div>
                    </div>
                    <div class="mb-3 position-relative">
                        <label for="password" class="form-label">Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            <input type="password" class="form-control" id="password" placeholder="Enter your password" required />
                            <span class="password-toggle" onclick="togglePasswordVisibility()">
                                <i class="far fa-eye" id="passwordToggleIcon"></i>
                            </span>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="rememberMe">
                            <label class="form-check-label text-muted small" for="rememberMe">
                                Remember me
                            </label>
                        </div>
                        <a href="http://127.0.0.1:5000/forgot_password_page" class="text-decoration-none small text-success">Forgot password?</a>
                    </div>
                    <button type="submit" class="btn btn-success w-100 py-2 mb-4">SIGN IN</button>
                </form>

                <p class="text-center mt-3 small">
                    Don't have an account? <a href="http://127.0.0.1:5000/register" class="text-success fw-bold text-decoration-none">SIGN UP</a>
                </p>
            </div>
        </div>

        <div class="auth-promo-section">
            <div class="promo-content">
                <img src="/static/cropped-nsuk.png" alt="University Logo" class="promo-logo mb-4">
                <h2 class="fw-bold mb-3">Glad to see you!</h2>
                <p class="mb-4">Nasarawa State University, Keffi Venue Booking System - Streamlining your venue reservations for academic and administrative purposes.</p>
                <a href="http://127.0.0.1:5000/register" class="btn btn-success btn-lg rounded-pill px-5 py-3 fw-bold shadow">SIGN UP</a>
            </div>
        </div>
    </div>

    <div class="modal fade" id="customModal" tabindex="-1" aria-labelledby="customModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="customModalBody">
                </div>
                <div class="modal-footer" id="customModalFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success d-none" id="customModalConfirmBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // YOUR FIREBASE CONFIGURATION - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); // Get Firebase Auth instance

        // Base URL for API calls (adjust if your Flask app is on a different host/port)
        const API_BASE_URL = 'http://127.0.0.1:5000';

        // Function to display messages (success or error)
        function showMessage(message, isError = false, targetId = "messageDisplay") {
            const messageDiv = document.getElementById(targetId);
            if (messageDiv) {
                messageDiv.textContent = message;
                messageDiv.className = `alert ${isError ? 'alert-danger' : 'alert-success'} d-block`;
                setTimeout(() => {
                    messageDiv.classList.remove('d-block');
                    messageDiv.classList.add('d-none');
                }, 3000); // Hide after 3 seconds for consistency
            }
        }

        // Function to toggle password visibility
        function togglePasswordVisibility() {
            const passwordField = document.getElementById("password");
            const icon = document.getElementById("passwordToggleIcon");
            if (passwordField.type === "password") {
                passwordField.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                passwordField.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }

        // --- Custom Alert/Confirm Modals (replaces browser's alert/confirm) ---
        // This structure is added here for consistency, ensuring all pages have the modal functionality.
        // It's checked in DOMContentLoaded to prevent multiple additions.

        function showCustomModal(title, bodyHtml, isConfirm = false, onConfirmCallback = null) {
            const modalElement = document.getElementById('customModal');
            const modalTitle = document.getElementById('customModalLabel');
            const modalBody = document.getElementById('customModalBody');
            const modalConfirmBtn = document.getElementById('customModalConfirmBtn');
            const bootstrapModal = new bootstrap.Modal(modalElement);

            modalTitle.textContent = title;
            modalBody.innerHTML = bodyHtml;

            if (isConfirm) {
                modalConfirmBtn.classList.remove('d-none');
                modalConfirmBtn.onclick = () => {
                    bootstrapModal.hide();
                    if (onConfirmCallback) {
                        onConfirmCallback();
                    }
                };
            } else {
                modalConfirmBtn.classList.add('d-none');
                modalConfirmBtn.onclick = null; // Clear previous click handler
            }

            bootstrapModal.show();
        }

        // A wrapper for confirm-like actions using the custom modal
        function showCustomConfirm(message, onConfirmCallback) {
            showCustomModal('Confirmation', message, true, onConfirmCallback);
        }

        // Event listener for the login form submission
        document.getElementById("loginForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            // Clear previous messages
            showMessage('', false);
            document.getElementById('messageDisplay').classList.add('d-none'); // Hide it immediately

            const role = document.getElementById("role").value;
            const identifier = document.getElementById("identifier").value; // Get the identifier (email or matric_no)
            const password = document.getElementById("password").value;

            if (!identifier || !password || !role) {
                showMessage('Please fill in all fields (Email/ID, Password, and Role).', true);
                return;
            }

            try {
                // Send identifier, password, and role to Flask backend
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ identifier: identifier, password: password, role: role })
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage("Login successful! Redirecting...", false);
                    if (role === "admin") {
                        window.location.href = `${API_BASE_URL}/admin/dashboard`;
                    } else if (role === "student") {
                        window.location.href = `${API_BASE_URL}/student/dashboard`;
                    }
                } else {
                    showMessage(result.error || "Login failed. Please try again.", true);
                }
            } catch (error) {
                console.error("Login request error:", error);
                showMessage('Login failed due to network error. Please check your internet connection and try again.', true);
            }
        });

        // Ensure the custom modal HTML is present in the DOM
        document.addEventListener('DOMContentLoaded', () => {
            if (!document.getElementById('customModal')) {
                const modalHtml = `
                    <div class="modal fade" id="customModal" tabindex="-1" aria-labelledby="customModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="customModalLabel"></h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body" id="customModalBody">
                                </div>
                                <div class="modal-footer" id="customModalFooter">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-success d-none" id="customModalConfirmBtn">Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
        });
    </script>
</body>
</html>